# 第九章 不安全代码

仅仅提及“不安全代码”就常常会引起 Rust 社区以及许多旁观者的强烈反应。有些人认为这“没什么大不了的”，而另一些人则谴责这是“Rust 所有承诺都是谎言的原因”。在本章中，我希望稍微揭开神秘的面纱，解释什么是不安全代码，什么不安全，
以及如何安全地使用它。在撰写本文时，很可能在您阅读本文时，Rust 对不安全代码的具体要求仍在确定中，即使它们全部确定下来，完整的描述也超出了本书的范围。相反，我会尽力为您提供所需的构建块、直觉和工具，
帮助您在大多数不安全代码中游刃有余。

&nbsp;&nbsp;&nbsp;&nbsp;你从本章中应该学到的主要内容是：不安全代码是 Rust 为开发者提供的机制，让他们能够利用编译器无法检查的不变量。我们将探讨不安全代码是如何做到这一点的，这些不变量可能是什么，以及我们可以用它做什么。

> 不变量
>
> 在本章中，我将大量讨论不变量。不变量只是“程序正确性必须为真”的一种说法。例如，在 Rust 中，一个不变量是使用 & 和 &mut 的引用不会悬垂——它们始终指向有效值。你还可以使用特定于应用程序或库的不变量，例如“头指针始终位于尾指针之前”或“容量始终是 2 的幂”。最终，不变量代表了代码正确性所需的所有假设。然而，你可能并不总是了解代码中使用的所有不变量，而这正是 bug 潜伏的地方。

&nbsp;&nbsp;&nbsp;&nbsp;至关重要的是，不安全代码并非规避 Rust 各种规则（例如借用检查）的一种方式，而是一种使用编译器之外的推理来强制执行这些规则的方法。当你编写不安全代码时，你有责任确保生成的代码是安全的。某种程度上，当 unsafe 作为一个关键字用于通过 unsafe {} 允许不安全操作时，它会产生误导；这并不是说包含的代码是不安全的，而是因为在特定上下文中，这些操作是安全的，所以允许代码执行原本不安全的操作。

&nbsp;&nbsp;&nbsp;&nbsp;本章的其余部分分为四个部分。我们将首先简要介绍关键字本身的用法，然后探讨 unsafe 可以做什么。接下来，我们将讨论编写安全的 unsafe 代码必须遵循的规则。最后，我将提供一些关于如何安全地编写 unsafe 代码的建议。

